import codat from "Codat-Lending.json"

// Customers (debtors)
schema Customer from codat.AccountingCustomer {
  id: unique uuid(),
  customerName: companyName(),
  contactName: fullName(),
  emailAddress: email(),
  phone: phone(),
  status: 0.85: "Active" | 0.15: "Archived",
  defaultCurrency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD"
}

// Invoice line items with computed tax
schema InvoiceLineItem {
  description: faker.commerce.productName(),
  quantity: int in 1..100,
  unitAmount: decimal in 10..5000,
  discountAmount: decimal in 0..100,
  taxAmount: = round(unitAmount * 0.2, 2),
  totalAmount: = round(unitAmount * quantity, 2)
}

// Invoices (accounts receivable)
schema Invoice from codat.AccountingInvoice {
  id: unique uuid(),
  invoiceNumber: = sequence("INV-", 1001),
  customerRef: any of customers where .status == "Active",
  issueDate: date in 2023..2024,
  dueDate: date in 2024..2024,
  currency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",
  lineItems: 1..8 * InvoiceLineItem,
  subTotal: = round(sum(lineItems.unitAmount), 2),
  totalTaxAmount: = round(sum(lineItems.taxAmount), 2),
  totalAmount: = round(sum(lineItems.totalAmount), 2),
  amountDue: = totalAmount,
  status: "Submitted"
}

// Payments against invoices
schema Payment from codat.AccountingPayment {
  id: unique uuid(),
  invoice: any of invoices where not (.status == "Paid" or .status == "Void"),
  amount: int in 100..5000,
  currency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",
  paymentDate: date in 2024..2024,
  note: sentence()?,
  reference: faker.string.alphanumeric(10)?,
  assume amount <= invoice.amountDue
} then {
  invoice.amountDue = invoice.amountDue - amount,
  invoice.status = invoice.amountDue <= 0 ? "Paid" : "PartiallyPaid"
}

// Chart of accounts
schema Account from codat.AccountingAccount {
  id: unique uuid(),
  nominalCode: faker.string.alphanumeric(6),
  name: faker.finance.accountNumber(),
  description: sentence()?,
  currency: "GBP" | "USD" | "EUR",
  currentBalance: decimal in 0..500000,
  type: 0.3: "Asset" | 0.2: "Liability" | 0.15: "Equity" | 0.2: "Income" | 0.15: "Expense",
  status: 0.9: "Active" | 0.1: "Archived",
  isBankAccount: 0.2: true | 0.8: false
}

// Suppliers (creditors)
schema Supplier from codat.AccountingSupplier {
  id: unique uuid(),
  supplierName: companyName(),
  contactName: fullName()?,
  emailAddress: email()?,
  phone: phone()?,
  status: 0.9: "Active" | 0.1: "Archived",
  defaultCurrency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD"
}

// Bill line items
schema BillLineItem {
  description: faker.commerce.productName(),
  quantity: int in 1..50,
  unitAmount: decimal in 10..2000,
  taxAmount: = round(unitAmount * 0.2, 2),
  totalAmount: = round(unitAmount * quantity, 2)
}

// Bills (accounts payable)
schema Bill from codat.AccountingBill {
  id: unique uuid(),
  reference: = sequence("BILL-", 1001),
  supplierRef: any of suppliers where .status == "Active",
  issueDate: date in 2023..2024,
  dueDate: date in 2024..2024,
  currency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",
  lineItems: 1..5 * BillLineItem,
  subTotal: = round(sum(lineItems.unitAmount), 2),
  totalTaxAmount: = round(sum(lineItems.taxAmount), 2),
  totalAmount: = round(sum(lineItems.totalAmount), 2),
  amountDue: = totalAmount,
  status: "Open"
}

// Payments against bills
schema BillPayment {
  bill: any of bills where not .status == "Paid",
  amount: int in 100..3000,
  paymentDate: date in 2024..2024,
  assume amount <= bill.amountDue
} then {
  bill.amountDue = bill.amountDue - amount,
  bill.status = bill.amountDue <= 0 ? "Paid" : "PartiallyPaid"
}

// Platform connections
schema Connection {
  integrationId: uuid(),
  platformName: "Xero" | "QuickBooks" | "Sage" | "FreshBooks" | "Wave",
  status: 0.85: "Linked" | 0.15: "Unlinked",
  sourceType: 0.7: "Accounting" | 0.2: "Banking" | 0.1: "Commerce"
}

// Companies with data connections
schema Company {
  name: companyName(),
  description: faker.company.catchPhrase()?,
  defaultCurrency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",
  dataConnections: 1..3 * Connection
}

dataset LendingTestData {
  companies: 20 * Company,
  accounts: 50 * Account,
  customers: 100 * Customer,
  suppliers: 50 * Supplier,
  invoices: 500 * Invoice,
  payments: 400 * Payment,
  bills: 200 * Bill,
  billPayments: 150 * BillPayment,

  validate {
    sum(invoices.totalAmount) >= 100000,
    sum(bills.totalAmount) <= sum(invoices.totalAmount) * 1.5,
    sum(payments.amount) <= sum(invoices.totalAmount),
    some(invoices, .status == "Paid"),
    all(invoices, .amountDue >= 0),
    all(bills, .amountDue >= 0)
  }
}
