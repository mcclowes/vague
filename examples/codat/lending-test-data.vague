import codat from "Codat-Lending.json"

schema Customer from codat.AccountingCustomer {
  id: uuid(),
  customerName: companyName(),
  contactName: fullName(),
  emailAddress: email(),
  phone: phone(),
  status: 0.85: "Active" | 0.15: "Archived",
  defaultCurrency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD"
}

schema InvoiceLineItem {
  description: faker.commerce.productName(),
  quantity: int in 1..100,
  unitAmount: decimal in 10..5000,
  discountAmount: decimal in 0..100,
  taxAmount: = unitAmount * 0.2,
  totalAmount: = unitAmount * quantity
}

schema Invoice from codat.AccountingInvoice {
  id: uuid(),
  invoiceNumber: faker.string.alphanumeric(8),
  customerRef: any of customers,
  issueDate: int in 1..28,
  dueDate: int in 1..90,
  currency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",
  lineItems: 1..8 * InvoiceLineItem,
  subTotal: = sum(lineItems.unitAmount),
  totalTaxAmount: = sum(lineItems.taxAmount),
  totalAmount: = sum(lineItems.totalAmount),
  amountDue: = totalAmount,  // payments will update via then blocks
  status: "Submitted",
  assume dueDate >= issueDate
}

schema PaymentLineLink {
  type: "Invoice" | "CreditNote" | "PaymentOnAccount",
  id: uuid(),
  amount: int in 0..10000
}

schema PaymentLine {
  amount: int in 0..10000,
  links: 1..3 * PaymentLineLink
}

schema Payment from codat.AccountingPayment {
  id: uuid(),
  invoice: any of invoices where .status != "Paid" and .status != "Void",
  amount: int in 100..5000,
  currency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",
  date: int in 1..28,
  note: sentence()?,
  reference: faker.string.alphanumeric(10)?,
  assume amount <= invoice.amountDue
} then {
  invoice.amountDue -= amount,
  invoice.status = invoice.amountDue <= 0 ? "Paid" : "PartiallyPaid"
}

schema Account from codat.AccountingAccount {
  id: uuid(),
  nominalCode: faker.string.alphanumeric(6),
  name: faker.finance.accountNumber(),
  description: sentence()?,
  currency: "GBP" | "USD" | "EUR",
  currentBalance: decimal in 0..500000,
  type: 0.3: "Asset" | 0.2: "Liability" | 0.15: "Equity" | 0.2: "Income" | 0.15: "Expense",
  status: 0.9: "Active" | 0.1: "Archived",
  isBankAccount: 0.2: true | 0.8: false
}

schema Supplier from codat.AccountingSupplier {
  id: uuid(),
  supplierName: companyName(),
  contactName: fullName()?,
  emailAddress: email()?,
  phone: phone()?,
  status: 0.9: "Active" | 0.1: "Archived",
  defaultCurrency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD"
}

schema BillLineItem {
  description: faker.commerce.productName(),
  quantity: int in 1..50,
  unitAmount: decimal in 10..2000,
  taxAmount: = unitAmount * 0.2,
  totalAmount: = unitAmount * quantity
}

schema Bill from codat.AccountingBill {
  id: uuid(),
  reference: faker.string.alphanumeric(8)?,
  supplierRef: any of suppliers,
  issueDate: int in 1..28,
  dueDate: int in 1..60,
  currency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",
  lineItems: 1..5 * BillLineItem,
  subTotal: = sum(lineItems.unitAmount),
  totalTaxAmount: = sum(lineItems.taxAmount),
  totalAmount: = sum(lineItems.totalAmount),
  amountDue: = totalAmount,
  status: "Open",
  assume dueDate >= issueDate
}

schema BillPayment {
  id: uuid(),
  bill: any of bills where .status != "Paid",
  amount: int in 100..3000,
  date: int in 1..28,
  assume amount <= bill.amountDue
} then {
  bill.amountDue -= amount,
  bill.status = bill.amountDue <= 0 ? "Paid" : "PartiallyPaid"
}

schema Connection {
  id: uuid(),
  integrationId: uuid(),
  platformName: "Xero" | "QuickBooks" | "Sage" | "FreshBooks" | "Wave",
  status: 0.85: "Linked" | 0.15: "Unlinked",
  sourceType: 0.7: "Accounting" | 0.2: "Banking" | 0.1: "Commerce"
}

schema Company {
  id: uuid(),
  name: companyName(),
  description: faker.company.catchPhrase()?,
  defaultCurrency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",
  dataConnections: 1..3 * Connection
}

dataset LendingTestData {
  companies: 20 * Company,
  accounts: 50 * Account,
  customers: 100 * Customer,
  suppliers: 50 * Supplier,
  invoices: 500 * Invoice,
  payments: 400 * Payment,  // mutate invoices via then blocks
  bills: 200 * Bill,
  billPayments: 150 * BillPayment,  // mutate bills via then blocks

  validate {
    sum(invoices.totalAmount) >= 100000,
    sum(bills.totalAmount) <= sum(invoices.totalAmount) * 1.5,  // AP shouldn't exceed AR
    sum(payments.amount) <= sum(invoices.totalAmount),
    some(invoices, .status == "Paid"),
    all(invoices, .amountDue >= 0),
    all(bills, .amountDue >= 0)
  }
}
