// Codat Lending API - Test Data Generation
// Based on https://github.com/codatio/oas
//
// This generates realistic test data for an SMB lending scenario:
// - Companies with connections to accounting platforms
// - Customers and suppliers
// - Invoices (accounts receivable) with line items
// - Payments against invoices
//
// Uses faker plugin for realistic semantic data generation.
// Generators like uuid(), email(), companyName() are provided by vague-faker.

// --- Base Schemas ---

schema Customer {
  id: uuid(),
  customerName: companyName(),
  contactName: fullName(),
  emailAddress: email(),
  phone: phone(),
  status: 0.85: "Active" | 0.15: "Archived",
  defaultCurrency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD"
}

schema InvoiceLineItem {
  description: faker.commerce.productName(),
  quantity: int in 1..100,
  unitAmount: decimal in 10..5000,
  discountAmount: decimal in 0..100,
  taxAmount: = unitAmount * 0.2,
  totalAmount: = unitAmount * quantity
}

schema Invoice {
  id: uuid(),
  invoiceNumber: faker.string.alphanumeric(8),
  customerRef: any of customers,
  issueDate: int in 1..28,
  dueDate: int in 1..90,
  currency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",

  lineItems: 1..8 * InvoiceLineItem,

  // Computed totals
  subTotal: = sum(lineItems.unitAmount),
  totalTaxAmount: = sum(lineItems.taxAmount),
  totalAmount: = sum(lineItems.totalAmount),

  status: 0.4: "Paid" | 0.3: "Submitted" | 0.15: "PartiallyPaid" | 0.1: "Draft" | 0.05: "Void",
  amountDue: int in 0..10000,

  // Constraints
  assume dueDate >= issueDate,
  assume if status == "Paid" {
    amountDue == 0
  },
  assume if status == "Draft" {
    amountDue == totalAmount
  }
}

schema PaymentLineLink {
  type: "Invoice" | "CreditNote" | "PaymentOnAccount",
  id: uuid(),
  amount: int in 0..10000
}

schema PaymentLine {
  amount: int in 0..10000,
  links: 1..3 * PaymentLineLink
}

schema Payment {
  id: uuid(),
  customerRef: any of customers,
  totalAmount: int in 100..50000,
  currency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",
  paymentDate: int in 1..28,
  lines: 1..5 * PaymentLine,
  note: sentence()?,
  reference: faker.string.alphanumeric(10)?
}

schema Account {
  id: uuid(),
  nominalCode: faker.string.alphanumeric(6),
  name: faker.finance.accountNumber(),
  description: sentence()?,
  currency: "GBP" | "USD" | "EUR",
  currentBalance: decimal in 0..500000,
  type: 0.3: "Asset" | 0.2: "Liability" | 0.15: "Equity" | 0.2: "Income" | 0.15: "Expense",
  status: 0.9: "Active" | 0.1: "Archived",
  isBankAccount: 0.2: true | 0.8: false
}

schema Supplier {
  id: uuid(),
  supplierName: companyName(),
  contactName: fullName()?,
  emailAddress: email()?,
  phone: phone()?,
  status: 0.9: "Active" | 0.1: "Archived",
  defaultCurrency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD"
}

schema BillLineItem {
  description: faker.commerce.productName(),
  quantity: int in 1..50,
  unitAmount: decimal in 10..2000,
  taxAmount: = unitAmount * 0.2,
  totalAmount: = unitAmount * quantity
}

schema Bill {
  id: uuid(),
  billNumber: faker.string.alphanumeric(8)?,
  supplierRef: any of suppliers,
  issueDate: int in 1..28,
  dueDate: int in 1..60,
  currency: = ^defaultCurrency,

  lineItems: 1..5 * BillLineItem,

  subTotal: = sum(lineItems.unitAmount),
  totalTaxAmount: = sum(lineItems.taxAmount),
  totalAmount: = sum(lineItems.totalAmount),

  status: 0.5: "Open" | 0.35: "Paid" | 0.1: "PartiallyPaid" | 0.05: "Void",
  amountDue: int in 0..5000,

  assume dueDate >= issueDate,
  assume if status == "Paid" {
    amountDue == 0
  }
}

schema Connection {
  id: uuid(),
  integrationId: uuid(),
  platformName: "Xero" | "QuickBooks" | "Sage" | "FreshBooks" | "Wave",
  status: 0.85: "Linked" | 0.15: "Unlinked",
  sourceType: 0.7: "Accounting" | 0.2: "Banking" | 0.1: "Commerce"
}

schema Company {
  id: uuid(),
  name: companyName(),
  description: faker.company.catchPhrase()?,
  defaultCurrency: 0.6: "GBP" | 0.25: "USD" | 0.1: "EUR" | 0.05: "AUD",
  dataConnections: 1..3 * Connection
}

// --- Dataset Definition ---

dataset LendingTestData {
  // Companies applying for lending
  companies: 20 * Company,

  // Chart of accounts
  accounts: 50 * Account,

  // Customers (debtors)
  customers: 100 * Customer,

  // Suppliers (creditors)
  suppliers: 50 * Supplier,

  // Accounts receivable
  invoices: 500 * Invoice,

  // Payments received
  payments: 300 * Payment,

  // Accounts payable
  bills: 200 * Bill
}
